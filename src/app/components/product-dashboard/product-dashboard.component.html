<div class="container mt-4">
  <header class="d-flex justify-content-between align-items-center mb-4">
    <h1>Gestión de Productos</h1>
    <button class="btn btn-primary" (click)="open(addProductModal)">
      Agregar producto
    </button>
  </header>

  <div *ngIf="products$ | async as products; else loading" class="table-responsive">
  
  <p *ngIf="products.length === 0" class="text-center">No hay productos para mostrar.</p>

  <table *ngIf="products.length > 0" class="table table-striped table-hover align-middle">
    <thead class="thead-dark">
      <tr>
        <th scope="col" style="width: 5%;"></th>
        <th scope="col">Nombre</th>
        <th scope="col">Precio</th>
        <th scope="col">Stock</th>
        <th scope="col" class="text-end">Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let product of products">
        <td>
          <img [src]="'https://api.dicebear.com/8.x/icons/svg?backgroundType=gradientLinear&seed=' + product.id" 
           alt="Avatar del producto" 
           class="product-avatar">
        </td>
        <td>{{ product.nombre }}</td>
        <td>{{ product.precio | currency:'CLP':'symbol':'1.0-0':'es-CL' }}</td>
        <td>{{ product.stock }}</td>
        <td class="text-end">
          <button class="btn btn-danger btn-sm" (click)="onDeleteProduct(product.id)">
            Eliminar
          </button>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<ng-template #loading>
  <p class="text-center">Cargando productos...</p>
</ng-template>
</div>

<ng-template #addProductModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title text-center">Agregar Nuevo Producto</h4>
    <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
  </div>

  <div class="modal-body">
    <form *ngIf="!showSuccessView" [formGroup]="productForm" (ngSubmit)="onSubmit()" class="form-container">
      <div class="mb-3">
        <label for="nombre" class="form-label">Nombre del producto</label>
        <input type="text" class="form-control" id="nombre" formControlName="nombre">
        </div>
      <div class="mb-3">
        <label for="precio" class="form-label">Precio</label>
        <input type="number" class="form-control" id="precio" formControlName="precio" min="1">
        </div>
      <div class="mb-3">
        <label for="stock" class="form-label">Stock</label>
        <input type="number" class="form-control" id="stock" formControlName="stock" min="1">
        </div>
    </form>

    <div *ngIf="showSuccessView" class="success-view">
      <div class="success-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50">
          <circle style="fill:#25AE88;" cx="25" cy="25" r="25"/>
          <polyline style="fill:none;stroke:#FFFFFF;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:10;" points="38,15 22,33 12,25 "/>
        </svg>
      </div>
      <h4 class="mt-3">¡Producto Agregado!</h4>
    </div>
  </div>

  <div *ngIf="!showSuccessView" class="modal-footer form-container">
    <button type="button" class="btn btn-light" (click)="modal.dismiss()">Cancelar</button>
    <button type="submit" class="btn btn-primary" (click)="onSubmit()" [disabled]="productForm.invalid">Guardar</button>
  </div>
</ng-template>